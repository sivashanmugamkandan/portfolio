import sgMail from "@sendgrid/mail";
import Twilio from "twilio";

sgMail.setApiKey(process.env.SENDGRID_API_KEY);
const twilio = new Twilio(process.env.TWILIO_SID, process.env.TWILIO_AUTH);

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).end();

  try {
    const { name, email, message } = req.body;

    if (!name || !email || !message) {
      return res.status(400).json({ error: "All fields are required" });
    }

    // ✅ Send email
    await sgMail.send({
      to: process.env.CONTACT_EMAIL,
      from: process.env.SENDGRID_FROM,
      subject: `New Portfolio Contact from ${name}`,
      text: `${message}\n\nFrom: ${name} <${email}>`
    });

    // ✅ Send WhatsApp
    await twilio.messages.create({
      from: process.env.TWILIO_WHATSAPP_FROM, // e.g. whatsapp:+14155238886
      to: `whatsapp:${process.env.ADMIN_WHATSAPP}`, // your number
      body: `New contact from ${name} (${email}): ${message}`
    });

    res.status(200).json({ success: true });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Server error" });
  }
}
